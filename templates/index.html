<!DOCTYPE html>
<html>
  <head>
    <title>1-Min Trigger Monitor - Davao</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      #map { height: 90vh; width: 100%; }
      body { font-family: "Courier New", monospace; background: #000; color: #0f0; margin: 0; }
      .ui { padding: 10px; background: #111; border-bottom: 1px solid #0f0; }
    </style>
  </head>
  <body>
    <div class="ui">
      <b>COMMAND CENTER: DAVAO CITY (AGDAO)</b>
      | STATUS: <span id="status">SYNCING...</span>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([7.0825, 125.6240], 17);

      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);

      const roads = [
        {
          name: "Soliman St (Agdao)",
          coords: [[7.0818, 125.6231], [7.0838, 125.6251]],
          layer: null,
        },
      ];

      function getEvacuationColor(countPerMinute) {
        if (countPerMinute > 10) return "#ff0000"; // Severe (Red)
        if (countPerMinute > 5) return "#ffa500";  // Moderate (Orange)
        return "#00ff00";                         // Low (Green)
      }

      async function refreshMap() {
        try {
          const response = await fetch("/api/crowd");
          const data = await response.json();

          document.getElementById("status").innerText =
            "LIVE (Trigger Line Active) - Sync: " + new Date().toLocaleTimeString();

          roads.forEach((road) => {
            const total = data[road.name] || 0;
            const color = getEvacuationColor(total);

            if (road.layer) map.removeLayer(road.layer);

            road.layer = L.polyline(road.coords, {
              color: color,
              weight: 12,
              opacity: 0.8,
            })
              .addTo(map)
              .bindPopup(
                `<b>${road.name}</b><br>People crossed line in last minute: ${total}`
              );
          });
        } catch (err) {
          console.log("Connecting to AI server...");
        }
      }

      // Sync every minute
      setInterval(refreshMap, 60000);
      refreshMap();
    </script>
  </body>
</html>